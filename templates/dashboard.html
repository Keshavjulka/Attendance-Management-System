{% extends "base.html" %}

{% block title %}Dashboard - Face Attendance System{% endblock %}

{% block content %}
<!-- Welcome Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="display-6 mb-0"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h1>
                <p class="text-muted">8/4/2025 <span class="badge bg-info ms-2">12:45:09 AM</span></p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('manual_attendance') }}" class="btn btn-primary">
                    <i class="fas fa-check me-2"></i>Mark Attendance
                </a>
                <a href="{{ url_for('register_student') }}" class="btn btn-success">
                    <i class="fas fa-user-plus me-2"></i>Add Student
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Real-Time Clock Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-gradient-primary text-white">
            <div class="card-body text-center">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h3 class="mb-0">
                            <i class="fas fa-clock me-2"></i>Current Time
                        </h3>
                    </div>
                    <div class="col-md-6">
                        <h2 class="mb-0" id="realTimeClock">--:--:-- --</h2>
                        <small id="currentDate">Loading...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-users fa-3x text-primary mb-3"></i>
                <h4 class="text-primary">Total Students</h4>
                <h2 class="text-primary" id="totalStudents">{{ stats.total_students }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-clock fa-3x text-success mb-3"></i>
                <h4 class="text-success">Today's Attendance</h4>
                <h2 class="text-success" id="presentToday">{{ stats.present_today }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-list fa-3x text-warning mb-3"></i>
                <h4 class="text-warning">Current Lecture</h4>
                <h2 class="text-warning" id="currentLecture">{{ stats.current_lecture or 1 }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-percentage fa-3x text-info mb-3"></i>
                <h4 class="text-info">Attendance Rate</h4>
                <h2 class="text-info" id="attendanceRate">{{ "%.0f"|format(stats.attendance_rate) }}%</h2>
            </div>
        </div>
    </div>
</div>

<!-- Management Sections -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-user-graduate me-2"></i>Student Management</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Register new students and manage existing records.</p>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('register_student') }}" class="btn btn-primary">
                        <i class="fas fa-user-plus me-2"></i>Add New Student
                    </a>
                    <a href="{{ url_for('reports') }}" class="btn btn-outline-primary">
                        <i class="fas fa-cogs me-2"></i>Manage Students
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Attendance Management</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Mark attendance and manage lecture sessions.</p>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('manual_attendance') }}" class="btn btn-success">
                        <i class="fas fa-check me-2"></i>Mark Attendance
                    </a>
                    <button class="btn btn-outline-success" onclick="setLectureNumber()">
                        <i class="fas fa-calendar me-2"></i>Set Lecture Number
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity & Quick Export -->
<div class="row">
    <!-- Recent Attendance -->
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Recent Attendance
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshActivity()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Roll No.</th>
                                <th>Time</th>
                                <th>Lecture</th>
                            </tr>
                        </thead>
                        <tbody id="recentAttendanceTable">
                            {% if recent_activities %}
                                {% for activity in recent_activities %}
                                <tr>
                                    <td>{{ activity.student_name }}</td>
                                    <td>{{ activity.student_id }}</td>
                                    <td>{{ activity.timestamp.strftime('%H:%M:%S') }}</td>
                                    <td>
                                        <span class="badge bg-primary">Lecture {{ activity.lecture or 1 }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">No recent attendance records</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Export -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-download me-2"></i>Quick Export
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('export_daily_report_excel') }}" class="btn btn-success">
                        <i class="fas fa-file-excel me-2"></i>Today's Attendance (Excel)
                    </a>
                    <a href="{{ url_for('export_students_excel') }}" class="btn btn-info">
                        <i class="fas fa-file-excel me-2"></i>All Students (Excel)
                    </a>
                    <a href="{{ url_for('export_attendance_excel') }}" class="btn btn-warning">
                        <i class="fas fa-file-excel me-2"></i>All Attendance Records (Excel)
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
.card-header {
    border-bottom: 1px solid rgba(0,0,0,0.125);
}
.stat-card {
    transition: transform 0.2s;
}
.stat-card:hover {
    transform: translateY(-5px);
}
#realTimeClock {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Set lecture number
function setLectureNumber() {
    const lectureNumber = prompt('Enter lecture number:', '1');
    if (lectureNumber && !isNaN(lectureNumber)) {
        fetch('/api/set_lecture', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                lecture_number: parseInt(lectureNumber)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Lecture number set to: ' + lectureNumber);
                document.getElementById('currentLecture').textContent = lectureNumber;
            } else {
                alert('Error setting lecture number');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error setting lecture number');
        });
    }
}

// Export functions
function exportTodayAttendance() {
    window.open('/api/export_today_attendance', '_blank');
}

function exportAllStudents() {
    window.open('/api/export_all_students', '_blank');
}

function exportReports() {
    window.open('/api/export_monthly_report', '_blank');
}

// Refresh activity
function refreshActivity() {
    fetch('/api/recent_attendance')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('recentAttendanceTable');
            if (data.attendance && data.attendance.length > 0) {
                tbody.innerHTML = data.attendance.map(record => `
                    <tr>
                        <td>${record.student_name}</td>
                        <td>${record.student_id}</td>
                        <td>${record.time}</td>
                        <td><span class="badge bg-primary">Lecture ${record.lecture || 1}</span></td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No recent attendance records</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error refreshing activity:', error);
        });
}

// Refresh data function
function refreshData() {
    const refreshIcon = document.getElementById('refreshIcon');
    if (refreshIcon) {
        refreshIcon.classList.add('fa-spin');
    }
    
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            // Update statistics
            document.getElementById('totalStudents').textContent = data.total_students;
            document.getElementById('presentToday').textContent = data.present_today;
            document.getElementById('currentLecture').textContent = data.current_lecture || 1;
            document.getElementById('attendanceRate').textContent = Math.round(data.attendance_rate) + '%';
            
            // Show success message
            showToast('Data refreshed successfully!', 'success');
        })
        .catch(error => {
            console.error('Error refreshing data:', error);
            showToast('Error refreshing data', 'error');
        })
        .finally(() => {
            if (refreshIcon) {
                refreshIcon.classList.remove('fa-spin');
            }
        });
}

// Toast notification function
function showToast(message, type) {
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    const toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
    toastContainer.innerHTML = toastHtml;
    document.body.appendChild(toastContainer);
    
    const toast = new bootstrap.Toast(toastContainer.querySelector('.toast'));
    toast.show();
    
    setTimeout(() => {
        toastContainer.remove();
    }, 5000);
}

// Auto-refresh data every 30 seconds
setInterval(refreshData, 30000);

// Update time every second
function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', { 
        hour12: true, 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
    });
    const dateString = now.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    document.getElementById('realTimeClock').textContent = timeString;
    document.getElementById('currentDate').textContent = dateString;
    document.title = `Dashboard - ${timeString} - Face Attendance System`;
}

// Update clock immediately and then every second
updateTime();
setInterval(updateTime, 1000);
</script>
{% endblock %}
